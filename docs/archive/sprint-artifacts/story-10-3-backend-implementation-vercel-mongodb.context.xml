<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>10</epicId>
    <storyId>10.3</storyId>
    <title>Backend Implementation (Vercel + MongoDB)</title>
    <status>drafted</status>
    <generatedAt>2025-12-02</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/story-10-3-backend-implementation-vercel-mongodb.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>Developer</asA>
    <iWant>the actual backend infrastructure running</iWant>
    <soThat>the app stops relying on client-side mocks or direct API calls where inappropriate</soThat>
    <tasks>
- [ ] Initialize Backend Repo (AC: 1)
  - [ ] Create `backend` directory.
  - [ ] Initialize Python environment (`requirements.txt`).
  - [ ] Create `api/index.py` (Flask app).

- [ ] Setup MongoDB Atlas (AC: 2)
  - [ ] **Interactive:** Ask user to create MongoDB Atlas cluster.
  - [ ] **Interactive:** Ask user for connection string.
  - [ ] Configure environment variables.

- [ ] Implement NASA Data Processor (AC: 3)
  - [ ] **Interactive:** Explain calculation logic (Radiance -> MPSAS) to user.
  - [ ] **Interactive:** Explain MongoDB storage strategy (Geospatial data).
  - [ ] Write script to process HDF5 files.
  - [ ] Write script to upload to MongoDB.

- [ ] Setup Vercel Deployment (AC: 2)
  - [ ] Configure `vercel.json`.
  - [ ] **Interactive:** Ask user to deploy to Vercel.

- [ ] Implement API Endpoint (AC: 4)
  - [ ] Implement `GET /api/light-pollution`.
  - [ ] Connect to MongoDB.
  - [ ] Return JSON response.

- [ ] Verify Client Integration (AC: 5)
  - [ ] Test app with real backend URL.
  - [ ] Verify fallback behavior.
    </tasks>
  </story>

  <acceptanceCriteria>
1. **Repo Setup**
   - [ ] Create `astr-backend` (or `backend` folder) with Python/Flask project.
   - [ ] Configure `vercel.json` for serverless deployment.

2. **Infrastructure**
   - [ ] Setup MongoDB Atlas (Free Tier) and get connection string.
   - [ ] Deploy Vercel Serverless Functions.

3. **Data Processing (NASA VNP46A2)**
   - [ ] Implement offline Python script to process NASA VNP46A2 HDF5 data.
   - [ ] Convert Radiance to MPSAS using formula: `12.589 - 1.086 * log(radiance)`.
   - [ ] Populate MongoDB with processed data (Geospatial index).

4. **API Endpoint**
   - [ ] Expose `GET /api/light-pollution?lat={lat}&lon={lon}` endpoint.
   - [ ] Return MPSAS and Bortle class.

5. **Verification**
   - [ ] Verify Story 2.4's client integration against this real backend.
   - [ ] Verify PNG fallback works when backend is unreachable.
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/backend-architecture-research.md</path>
        <title>Backend Architecture Research</title>
        <section>Recommended Architecture</section>
        <snippet>
          Primary Recommendation: Vercel Serverless + MongoDB Atlas (Zero Cost).
          Backend: Vercel Serverless Function (Python 3.12).
          Database: MongoDB Atlas Free Tier (512MB, 2dsphere geospatial index).
          Data Source: NASA Black Marble VNP46A2 (pre-computed monthly, uploaded to MongoDB).
        </snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epics & Stories</title>
        <section>Story 10.3</section>
        <snippet>
          Repo: Create astr-backend (or backend folder) with Python/Flask project.
          Infrastructure: Deploy Vercel Serverless Functions. Setup MongoDB Atlas (Free Tier).
          Data: Implement offline Python script to process NASA VNP46A2 HDF5 data and populate MongoDB.
        </snippet>
      </doc>
    </docs>
    <code>
      <item>
        <path>lib/features/dashboard/data/repositories/light_pollution_repository.dart</path>
        <kind>repository</kind>
        <symbol>LightPollutionRepository</symbol>
        <lines>9-48</lines>
        <reason>Existing client-side repository that calls the backend API. Needs verification against the real endpoint.</reason>
      </item>
    </code>
    <dependencies>
      <ecosystem name="python">
        <package name="Flask" version="3.0.0" />
        <package name="pymongo" version="4.6.0" />
        <package name="h5py" version="3.10.0" />
        <package name="numpy" version="1.26.0" />
      </ecosystem>
      <ecosystem name="vercel">
        <config>vercel.json</config>
      </ecosystem>
    </dependencies>
  </artifacts>

  <constraints>
    - **Interactive Mode Required:** The user explicitly requested a holistic and interactive process.
    - **Cost:** Must use Free Tier for Vercel and MongoDB Atlas.
    - **Data Source:** Must use NASA VNP46A2 HDF5 data (public domain).
    - **Offline Fallback:** Must verify that the app falls back to PNG map if backend is unreachable.
  </constraints>
  <interfaces>
    <interface>
      <name>GET /api/light-pollution</name>
      <kind>REST Endpoint</kind>
      <signature>GET /api/light-pollution?lat={lat}&lon={lon}</signature>
      <path>backend/api/index.py</path>
    </interface>
  </interfaces>
  <tests>
    <standards>
      Verify backend endpoint using `curl` or Postman.
      Verify client integration by running the app and checking network requests.
      Verify offline fallback by disconnecting network or using invalid URL.
    </standards>
    <locations>
      <location>backend/tests/</location>
      <location>test/features/dashboard/data/repositories/light_pollution_repository_test.dart</location>
    </locations>
    <ideas>
      - Test API with valid coordinates (returns JSON).
      - Test API with invalid coordinates (returns 400/404).
      - Test API with missing params.
      - Test offline script with sample HDF5 file.
    </ideas>
  </tests>
</story-context>

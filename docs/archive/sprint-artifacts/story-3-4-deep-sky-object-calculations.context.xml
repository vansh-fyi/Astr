<story_context>
  <story_id>3.4</story_id>
  <story_key>3-4-deep-sky-object-calculations</story_key>
  <story_title>Deep Sky Object Calculations</story_title>
  <status>ready-for-dev</status>

  <user_story>
    <as_a>User</as_a>
    <i_want>accurate position and visibility data for Stars, Constellations, Galaxies, and Nebulae</i_want>
    <so_that>I can plan observations for deep sky objects beyond just the Solar System</so_that>
  </user_story>

  <acceptance_criteria>
    <criterion id="1">
      <description>Implement calculation of Altitude/Azimuth for major stars (e.g., Sirius, Betelgeuse).</description>
    </criterion>
    <criterion id="2">
      <description>Verify accuracy against Swiss Ephemeris or known data.</description>
    </criterion>
    <criterion id="3">
      <description>Implement calculation of center-point Altitude/Azimuth for major constellations (e.g., Orion, Ursa Major).</description>
    </criterion>
    <criterion id="4">
      <description>Ensure "visibility" represents the constellation's general position.</description>
    </criterion>
    <criterion id="5">
      <description>Implement calculation of Altitude/Azimuth for Galaxies (e.g., Andromeda).</description>
    </criterion>
    <criterion id="6">
      <description>Implement calculation of Altitude/Azimuth for Nebulae (e.g., Orion Nebula).</description>
    </criterion>
    <criterion id="7">
      <description>Extend IAstroEngine (and AstroEngineSwissEph) to support CelestialType.star, constellation, galaxy, nebula.</description>
    </criterion>
    <criterion id="8">
      <description>Ensure performance remains within limits (&lt; 200ms for 12h graph).</description>
    </criterion>
    <criterion id="9">
      <description>Update CatalogRepository to provide sample data for these new types if not already present.</description>
    </criterion>
  </acceptance_criteria>

  <tasks>
    <task id="1">
      <title>Engine Extension</title>
      <subtasks>
        <subtask>Extend IAstroEngine interface with methods for DSOs (or generic calculatePosition(CelestialObject)).</subtask>
        <subtask>Implement Swiss Ephemeris logic for fixed bodies (Stars/DSOs).</subtask>
        <subtask>Implement logic for Constellation centers.</subtask>
        <subtask>Unit Test: Verify calculations for a known Star (e.g., Sirius).</subtask>
        <subtask>Unit Test: Verify calculations for a known Galaxy (e.g., Andromeda).</subtask>
      </subtasks>
    </task>
    <task id="2">
      <title>Repository &amp; Data</title>
      <subtasks>
        <subtask>Add sample Stars, Constellations, Galaxies, Nebulae to CatalogRepository (mock/static data).</subtask>
        <subtask>Ensure CelestialObject model supports these types correctly.</subtask>
      </subtasks>
    </task>
    <task id="3">
      <title>Integration &amp; Verification</title>
      <subtasks>
        <subtask>Verify VisibilityService works with these new object types without modification (polymorphism).</subtask>
        <subtask>Performance Test: Generate visibility graph for a DSO.</subtask>
      </subtasks>
    </task>
  </tasks>

  <artifacts>
    <docs>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-3.md</path>
        <title>Epic Technical Specification: Celestial Catalog &amp; Visibility Graph</title>
        <section>Detailed Design</section>
        <snippet>VisibilityService calculates the visibility curve for a specific object and location over a time range. CatalogRepository provides static data for celestial objects.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Document: Astr</title>
        <section>System Architecture</section>
        <snippet>AstroEngine (Dart) calculates positions. Repositories return Either&lt;Failure, Type&gt;.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/story-3-3-the-universal-visibility-graph-the-core-feature.md</path>
        <title>Story 3.3: The Universal Visibility Graph</title>
        <section>Learnings from Previous Story</section>
        <snippet>VisibilityService is implemented. CustomPaint is used instead of Rive. Performance is good (3ms).</snippet>
      </doc>
    </docs>

    <code>
      <item>
        <path>lib/features/astronomy/domain/repositories/i_astro_engine.dart</path>
        <kind>interface</kind>
        <symbol>IAstroEngine</symbol>
        <reason>Core interface to extend for DSO calculations.</reason>
      </item>
      <item>
        <path>lib/features/catalog/domain/repositories/i_catalog_repository.dart</path>
        <kind>interface</kind>
        <symbol>ICatalogRepository</symbol>
        <reason>Interface for fetching celestial objects.</reason>
      </item>
      <item>
        <path>lib/features/astronomy/domain/entities/celestial_body.dart</path>
        <kind>enum</kind>
        <symbol>CelestialBody</symbol>
        <reason>Currently limited to solar system. Needs review.</reason>
      </item>
      <item>
        <path>lib/features/catalog/domain/entities/celestial_object.dart</path>
        <kind>entity</kind>
        <symbol>CelestialObject</symbol>
        <reason>Has RA/Dec fields for DSOs.</reason>
      </item>
      <item>
        <path>lib/features/catalog/domain/entities/celestial_type.dart</path>
        <kind>enum</kind>
        <symbol>CelestialType</symbol>
        <reason>Supports star, constellation, galaxy, nebula.</reason>
      </item>
    </code>

    <dependencies>
      <dep>sweph</dep>
      <dep>fpdart</dep>
      <dep>riverpod</dep>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Must use Swiss Ephemeris (sweph) for calculations.</constraint>
    <constraint>Performance must be &lt; 200ms for 12h graph generation.</constraint>
    <constraint>Offline-first capability required.</constraint>
  </constraints>

  <tests>
    <standards>
      Use `flutter_test` for unit tests. Mock dependencies using `mockito`.
    </standards>
    <locations>
      <loc>test/features/astronomy</loc>
      <loc>test/features/catalog</loc>
    </locations>
    <ideas>
      <idea>Verify Sirius altitude calculation matches Stellarium.</idea>
      <idea>Verify Andromeda galaxy position calculation.</idea>
      <idea>Verify Constellation center calculation.</idea>
    </ideas>
  </tests>
</story_context>

<story-context id="10-2-logic-overhaul-deep-sky" v="1.0">
  <metadata>
    <epicId>10</epicId>
    <storyId>10.2</storyId>
    <title>Logic Overhaul &amp; Deep Sky</title>
    <status>drafted</status>
    <generatedAt>2025-12-02</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/story-10-2-logic-overhaul-deep-sky.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>Stargazer</asA>
    <iWant>accurate, relevant data including Deep Sky Objects</iWant>
    <soThat>I can plan serious observation sessions</soThat>
    <tasks>
- [ ] Update Cloud Cover Logic (AC: 1)
  - [ ] Modify `WeatherProvider` to fetch current cloud cover.
  - [ ] Update UI to show current condition.
  - [ ] Implement "Reload" button in `Dashboard` or `AtmosphericsSheet`.

- [ ] Implement Stargazing Quality Formula (AC: 2)
  - [ ] Create `QualityCalculator` service or utility.
  - [ ] Implement the weighted formula.
  - [ ] Update `Dashboard` to display the calculated score.

- [ ] Add Deep Sky Objects (AC: 3)
  - [ ] Extend `CelestialObject` entity to support Deep Sky types.
  - [ ] Update `AstronomyEngine` to calculate visibility for these new types.
  - [ ] Populate catalog with a set of Deep Sky Objects (e.g., Andromeda, Orion Nebula).

- [ ] Validation (AC: 4)
  - [ ] Create unit tests comparing app calculations with Stellarium data points.
</tasks>
  </story>

  <acceptanceCriteria>
1. **Cloud Cover Logic Update**
   - [ ] Remove "Average" logic for cloud cover.
   - [ ] Display **Current** cloud cover condition.
   - [ ] Add a manual "Reload" button to refresh data.

2. **Stargazing Quality Formula**
   - [ ] Implement weighted formula: `Score = (Bortle * 0.4) + (Cloud * 0.4) + (Moon * 0.2)`.
   - [ ] Ensure score is normalized to a 0-100 or similar scale for UI display.

3. **Deep Sky Objects Visibility**
   - [ ] Calculate and display visibility for Galaxies, Stars, and Constellations.
   - [ ] Ensure these objects are included in the catalog and detail views.

4. **Validation**
   - [ ] Verify calculations against Stellarium to ensure accuracy.
</acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/PRD.md</path>
        <title>Product Requirements Document</title>
        <section>Story 10.2: Logic Overhaul &amp; Deep Sky</section>
        <snippet>
          **Cloud Cover:** Remove "Average" logic. Display **Current** condition. Add a manual "Reload" button to refresh data.
          **Stargazing Quality:** Implement weighted formula: `Score = (Bortle * 0.4) + (Cloud * 0.4) + (Moon * 0.2)`.
          **Deep Sky Objects:** Calculate and display visibility for Galaxies, Stars, and Constellations (previously missing).
        </snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Document</title>
        <section>6. Implementation Patterns</section>
        <snippet>
          **Astronomy Engine:** Pure Dart (`swisseph`) for "Plug &amp; Play" stability across all platforms (Web/Mobile) without FFI complexity.
          **The "Result" Pattern (No Crashes):** Repositories MUST return `Future&lt;Either&lt;Failure, Type&gt;&gt;`.
        </snippet>
      </doc>
    </docs>
    <code>
      <item>
        <path>lib/features/astronomy/domain/services/astronomy_service.dart</path>
        <kind>service</kind>
        <symbol>AstronomyService</symbol>
        <reason>Core service for astronomical calculations. Needs to be extended for Deep Sky Objects.</reason>
      </item>
      <item>
        <path>lib/features/dashboard/presentation/providers/weather_provider.dart</path>
        <kind>provider</kind>
        <symbol>WeatherNotifier</symbol>
        <reason>Manages weather state. Needs update for current cloud cover and reload functionality.</reason>
      </item>
      <item>
        <path>lib/features/catalog/domain/entities/celestial_object.dart</path>
        <kind>entity</kind>
        <symbol>CelestialObject</symbol>
        <reason>Entity definition for celestial objects. Needs extension for Deep Sky types.</reason>
      </item>
    </code>
    <dependencies>
      <dep>sweph: ^3.2.1+2.10.3</dep>
      <dep>flutter_riverpod: ^2.6.1</dep>
      <dep>fpdart: ^1.1.0</dep>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Use `swisseph` for all astronomical calculations.</constraint>
    <constraint>Follow the "Result" pattern for error handling.</constraint>
    <constraint>Ensure offline capability for catalog and calculations.</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>AstronomyService.calculateVisibility</name>
      <kind>method</kind>
      <signature>List&lt;GraphPoint&gt; calculateVisibility({required HeavenlyBody body, required DateTime startTime, required double lat, required double long})</signature>
      <path>lib/features/astronomy/domain/services/astronomy_service.dart</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Unit tests should verify calculations against known values (e.g., Stellarium).
      Integration tests should ensure UI updates correctly with new data.
    </standards>
    <locations>
      <loc>test/features/astronomy/domain/services/</loc>
      <loc>test/features/dashboard/presentation/providers/</loc>
    </locations>
    <ideas>
      <idea>Verify Stargazing Quality score calculation with various inputs.</idea>
      <idea>Test Deep Sky Object visibility calculation against Stellarium data.</idea>
      <idea>Ensure "Reload" button triggers a fresh weather fetch.</idea>
    </ideas>
  </tests>
</story-context>

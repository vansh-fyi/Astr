<story-context id="2-1-visual-bortle-cloud-bars.context" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>2.1</storyId>
    <title>Visual Bortle & Cloud Bars</title>
    <status>drafted</status>
    <generatedAt>2025-11-29</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/2-1-visual-bortle-cloud-bars.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>User</asA>
    <iWant>to see the light pollution and cloud cover as visual bars</iWant>
    <soThat>I can understand conditions without reading numbers</soThat>
    <tasks>
      - [ ] Define `Weather` entity (cloudCover, seeing, etc.).
      - [ ] Define `IWeatherService` interface.
      - [ ] Define `BortleScale` enum/logic (Class 1-9).
      - [ ] Implement `OpenMeteoWeatherService` (Direct API call for now, as per Epic 6 note).
      - [ ] Create `WeatherRepository` to abstract the data source.
      - [ ] Create `BortleBar` widget (CustomPainter or Container with Gradient).
      - [ ] Create `CloudBar` widget.
      - [ ] Implement `GlassPanel` container if not already available (from Arch doc).
      - [ ] Add animations (Flutter `AnimationController` or `animate_do` package if allowed, otherwise standard `TweenAnimation`).
      - [ ] Create `WeatherNotifier` (Riverpod) to fetch data based on `AstrContext` (Location).
      - [ ] Unit Test: `OpenMeteoWeatherService` (Mock Dio/Http).
      - [ ] Widget Test: Verify Bars render correctly with given data.
      - [ ] Widget Test: Verify Error state renders.
    </tasks>
  </story>

  <acceptanceCriteria>
    - **AC-2.1.1** **Bortle Bar:** Displays a visual gradient (1-9) representing the Bortle Scale.
    - **AC-2.1.2** **Bortle Indicator:** Shows the current location's Bortle class (e.g., "Class 4") on the bar.
    - **AC-2.1.3** **Cloud Bar:** Displays a visual fill bar representing current cloud cover percentage (0-100%).
    - **AC-2.1.4** **Animation:** Both bars animate (fill up) on screen load (`animate-slide-up` or similar).
    - **AC-2.1.5** **Data Source:** Fetches current Cloud Cover from Open-Meteo API using the current location.
    - **AC-2.1.6** **Error Handling:** If weather fetch fails, displays a graceful error state (not a crash) on the Cloud Bar.
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/PRD.md</path>
        <title>Product Requirements Document</title>
        <section>MVP - Minimum Viable Product</section>
        <snippet>Visual Bortle Scale: Graphical bar (1-9) showing light pollution. Cloud Cover Bar: Visual representation of cloudiness.</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epics & Stories</title>
        <section>Story 2.1: Visual Bortle & Cloud Bars</section>
        <snippet>Bortle Bar: Visual gradient (1-9). Shows current location's Bortle class. Cloud Bar: Visual fill based on cloud %. UX: Bars animate (fill up) on load.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Document</title>
        <section>6. Implementation Patterns</section>
        <snippet>The "Glass" Pattern (UI): All container widgets should use the shared GlassPanel widget. Ensures consistent "Deep Cosmos" aesthetic.</snippet>
      </doc>
    </docs>
    <code>
      <item>
        <path>lib/features/context/domain/entities/astr_context.dart</path>
        <kind>entity</kind>
        <symbol>AstrContext</symbol>
        <reason>Holds the Location context needed to fetch weather data.</reason>
      </item>
      <item>
        <path>lib/core/services/device_location_service.dart</path>
        <kind>service</kind>
        <symbol>DeviceLocationService</symbol>
        <reason>Provides the location data used by AstrContext.</reason>
      </item>
      <item>
        <path>lib/core/widgets/glass_panel.dart</path>
        <kind>widget</kind>
        <symbol>GlassPanel</symbol>
        <reason>Required base widget for the bars (MISSING - Needs creation).</reason>
      </item>
    </code>
    <dependencies>
      <dep>flutter_riverpod</dep>
      <dep>fpdart</dep>
      <dep>dio</dep>
      <dep>equatable</dep>
    </dependencies>
  </artifacts>

  <constraints>
    - Use `fpdart` `Either<Failure, Weather>` for error handling in the Repository/Service.
    - Use `GlassPanel` style for UI consistency.
    - Open-Meteo API must be used (free, no key required for MVP).
    - Animations should be smooth (60fps).
  </constraints>

  <interfaces>
    <interface>
      <name>Open-Meteo API</name>
      <kind>REST</kind>
      <signature>GET https://api.open-meteo.com/v1/forecast?latitude={lat}&longitude={long}&current=cloud_cover</signature>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Unit tests for Services/Repositories using Mockito. Widget tests for UI components.
    </standards>
    <locations>
      test/features/dashboard/
      test/core/services/
    </locations>
    <ideas>
      - Mock OpenMeteo response (200 OK, 500 Error).
      - Verify Bortle Bar gradient colors.
      - Verify Cloud Bar width calculation based on percentage.
    </ideas>
  </tests>
</story-context>

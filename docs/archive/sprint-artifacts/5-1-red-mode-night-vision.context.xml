<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>epic-5</epicId>
    <storyId>5.1</storyId>
    <title>Red Mode (Night Vision)</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-11-30</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/5-1-red-mode-night-vision.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>User</asA>
    <iWant>to toggle a red filter over the screen</iWant>
    <soThat>I don't ruin my night vision while stargazing</soThat>
    <tasks>
- [ ] 1. Implement `RedModeNotifier` (AC: 1, 3)
  - [ ] Create `SettingsNotifier` (or `RedModeNotifier`) using Riverpod `NotifierProvider`.
  - [ ] Implement `toggleRedMode()` method.
  - [ ] Integrate `Hive` to persist the boolean state in the `settings` box.
  - [ ] Unit Test: Verify state toggles and persists to Hive.

- [ ] 2. Create `RedModeOverlay` Widget (AC: 2, 5)
  - [ ] Create a widget that wraps its child in a `ColorFiltered` or `IgnorePointer` + `Container` stack.
  - [ ] Use `ColorFilter.mode(Colors.red, BlendMode.multiply)` (or experiment with `overlay`/`modulate` for best results).
  - [ ] Ensure the overlay passes touch events through (if using Stack approach).

- [ ] 3. Integrate Overlay into App Shell (AC: 2, 3)
  - [ ] Modify `main.dart` or the root `App` widget.
  - [ ] Wrap the `MaterialApp` (or `Scaffold` in the shell) with `RedModeOverlay`.
  - [ ] Watch `RedModeNotifier` to conditionally apply the filter.
  - [ ] Manual Test: Verify overlay applies to all screens, including dialogs/bottom sheets if possible.

- [ ] 4. Add Toggle to Profile Screen (AC: 1)
  - [ ] Add a `SwitchListTile` (or custom design) to `ProfileScreen`.
  - [ ] Bind it to `RedModeNotifier`.
  - [ ] Widget Test: Verify tapping the switch updates the provider state.

- [ ] 5. Verify Legibility (AC: 4)
  - [ ] Manual Verification: Check key screens (Dashboard, Catalog, Forecast) with Red Mode on.
  - [ ] Ensure "Deep Cosmos" background and text contrast remains usable.
</tasks>
  </story>

  <acceptanceCriteria>
1.  **Toggle in Profile:** A "Red Mode" toggle switch is available in the Profile screen (or global settings).
2.  **Global Red Overlay:** When active, a pure red (`#FF0000`) overlay is applied to the entire application.
3.  **Persistence:** The Red Mode state persists across app restarts and navigation changes.
4.  **Legibility:** All UI elements and text remain legible under the red filter.
5.  **Implementation:** The overlay uses a blend mode (e.g., `BlendMode.multiply` or `BlendMode.color`) to effectively turn the UI red without obscuring content.
</acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-5.md</path>
        <title>Epic Technical Specification: Profile &amp; Personalization</title>
        <section>Detailed Design</section>
        <snippet>Red Mode (Night Vision): A global, persistent red overlay to preserve dark adaptation. Uses Riverpod (NotifierProvider) to manage global RedMode state. Implemented at the root level (AppShell).</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Document: Astr</title>
        <section>System Architecture</section>
        <snippet>AppShell[App Shell] -> Presentation Layer. Local Storage: Hive (Offline persistence). Box: settings (red_mode).</snippet>
      </doc>
    </docs>
    <code>
      <item>
        <path>lib/features/profile/presentation/profile_screen.dart</path>
        <kind>presentation</kind>
        <symbol>ProfileScreen</symbol>
        <lines>4-15</lines>
        <reason>Target screen for the Red Mode toggle.</reason>
      </item>
      <item>
        <path>lib/main.dart</path>
        <kind>entry_point</kind>
        <symbol>main</symbol>
        <lines>18-59</lines>
        <reason>Root of the application, likely place to inject the RedModeOverlay.</reason>
      </item>
      <item>
        <path>lib/config/theme/theme_logic.dart</path>
        <kind>provider</kind>
        <symbol>ThemeLogic</symbol>
        <lines>11-42</lines>
        <reason>Example of existing settings management using Riverpod and Hive.</reason>
      </item>
      <item>
        <path>lib/hive/hive.dart</path>
        <kind>infrastructure</kind>
        <symbol>initHive</symbol>
        <lines>9-17</lines>
        <reason>Hive initialization logic. Need to ensure 'settings' box is opened here.</reason>
      </item>
    </code>
    <dependencies>
      <dep>flutter_riverpod</dep>
      <dep>hive_ce</dep>
      <dep>hive_ce_flutter</dep>
    </dependencies>
  </artifacts>

  <constraints>
    - The overlay must be at the very top of the widget tree (above Navigator if possible) to cover everything.
    - BlendMode.multiply usually works best for "night mode" on dark themes.
    - State persistence uses the existing Hive setup.
  </constraints>
  <interfaces>
    <interface>
      <name>SettingsNotifier</name>
      <kind>Riverpod Notifier</kind>
      <signature>class SettingsNotifier extends _$SettingsNotifier</signature>
      <path>lib/features/profile/presentation/providers/settings_provider.dart</path>
    </interface>
  </interfaces>
  <tests>
    <standards>Unit tests for Notifier logic. Widget tests for Profile screen interaction. Manual testing for visual effect.</standards>
    <locations>test/features/profile/presentation/</locations>
    <ideas>
      - Test toggleRedMode updates state and writes to Hive.
      - Test RedModeOverlay applies ColorFilter when enabled.
      - Test ProfileScreen toggle switch reflects current state.
    </ideas>
  </tests>
</story-context>

<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>epic-5</epicId>
    <storyId>5.2</storyId>
    <title>Saved Locations</title>
    <status>drafted</status>
    <generatedAt>2025-11-30</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/5-2-saved-locations.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>User</asA>
    <iWant>to save my favorite dark sky spots</iWant>
    <soThat>I can check their conditions quickly</soThat>
    <tasks>
- [ ] 1. Implement `SavedLocation` Model & Hive Adapter (AC: 5)
  - [ ] Create `SavedLocation` class with `id` (UUID), `name`, `latitude`, `longitude`, `bortleClass`, `createdAt`.
  - [ ] Generate Hive adapter using `build_runner`.
  - [ ] Register adapter in `lib/hive/hive.dart`.

- [ ] 2. Implement `ProfileRepository` (Locations) (AC: 1, 2, 4, 5)
  - [ ] Create `ProfileRepository` (if not exists) or update it.
  - [ ] Implement `saveLocation(SavedLocation)`, `getSavedLocations()`, `deleteLocation(String id)`.
  - [ ] Use Hive `locations` box.
  - [ ] Unit Test: Verify CRUD operations.

- [ ] 3. Implement `SavedLocationsNotifier` (AC: 2)
  - [ ] Create Riverpod `NotifierProvider` to expose `List<SavedLocation>`.
  - [ ] Implement methods to load, add, and remove locations (calling Repository).

- [ ] 4. Update `ProfileScreen` UI (AC: 2, 4)
  - [ ] Add a "Saved Locations" section (ListView) to `ProfileScreen`.
  - [ ] Display location name and coordinates/Bortle.
  - [ ] Implement "Delete" action (e.g., swipe to dismiss or delete icon).

- [ ] 5. Implement "Save Location" Action (AC: 1)
  - [ ] Add "Save" button to Dashboard or Location Sheet (wherever manual location is set).
  - [ ] Logic: Capture current `AstrContext` location, generate UUID, save via Notifier.

- [ ] 6. Implement Context Switching (AC: 3)
  - [ ] On tap of saved location item in Profile:
  - [ ] Update `AstrContext` (via `AstrContextProvider`) with the selected location.
  - [ ] Navigate to Home/Dashboard.
  - [ ] Integration Test: Verify context update and navigation.
</tasks>
  </story>

  <acceptanceCriteria>
1.  **Save Location:** User can "Save" the current manual location.
2.  **List Locations:** Profile displays a list of "Saved Locations".
3.  **Context Switch:** Tapping a saved location switches the Global Location Context.
4.  **Delete Location:** User can delete a saved location.
5.  **Persistence:** Data persists across app restarts (Hive).
</acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-5.md</path>
        <title>Epic Technical Specification: Profile &amp; Personalization</title>
        <section>Detailed Design</section>
        <snippet>Saved Locations: Local persistence of user-selected locations using Hive. Uses `SavedLocation` entity and `ProfileRepository`.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Document: Astr</title>
        <section>Data Architecture</section>
        <snippet>Local Storage (Hive): Box `locations` stores List of `SavedLocation` objects.</snippet>
      </doc>
    </docs>
    <code>
      <item>
        <path>lib/hive/hive.dart</path>
        <kind>infrastructure</kind>
        <symbol>initHive</symbol>
        <lines>9-17</lines>
        <reason>Central Hive initialization. Must register new Adapter and open 'locations' box here.</reason>
      </item>
      <item>
        <path>lib/features/profile/presentation/profile_screen.dart</path>
        <kind>presentation</kind>
        <symbol>ProfileScreen</symbol>
        <lines>1-33</lines>
        <reason>UI to display the list of saved locations.</reason>
      </item>
      <item>
        <path>lib/features/context/presentation/providers/astr_context_provider.dart</path>
        <kind>provider</kind>
        <symbol>AstrContextNotifier</symbol>
        <reason>Manages global location context. Needs to be updated when a saved location is selected.</reason>
      </item>
    </code>
    <dependencies>
      <dep>hive_ce</dep>
      <dep>hive_ce_flutter</dep>
      <dep>flutter_riverpod</dep>
      <dep>uuid</dep>
    </dependencies>
  </artifacts>

  <constraints>
    - Use `uuid` package for unique IDs.
    - Ensure `locations` box is opened in `lib/hive/hive.dart`.
    - `ProfileRepository` should handle all Hive interactions for locations.
  </constraints>
  <interfaces>
    <interface>
      <name>SavedLocation</name>
      <kind>Hive Entity</kind>
      <signature>class SavedLocation { String id; String name; double latitude; double longitude; ... }</signature>
      <path>lib/features/profile/domain/entities/saved_location.dart</path>
    </interface>
    <interface>
      <name>ProfileRepository</name>
      <kind>Repository</kind>
      <signature>Future&lt;void&gt; saveLocation(SavedLocation location); Future&lt;List&lt;SavedLocation&gt;&gt; getSavedLocations();</signature>
      <path>lib/features/profile/data/repositories/profile_repository.dart</path>
    </interface>
  </interfaces>
  <tests>
    <standards>Unit tests for Repository and Notifier. Widget tests for Profile list.</standards>
    <locations>test/features/profile/</locations>
    <ideas>
      - Test `ProfileRepository` saves and retrieves locations from Hive.
      - Test `SavedLocationsNotifier` updates state correctly.
      - Test `ProfileScreen` renders list of locations.
      - Test tapping a location updates `AstrContext`.
    </ideas>
  </tests>
</story-context>

<story-context id="story-4-1-context" v="1.0">
  <metadata>
    <epicId>epic-4</epicId>
    <storyId>4.1</storyId>
    <title>7-Day Forecast List</title>
    <status>drafted</status>
    <generatedAt>2025-12-01</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/story-4-1-7-day-forecast-list.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>User</asA>
    <iWant>to see a list of the next 7 days with summary conditions</iWant>
    <soThat>I can pick the best night</soThat>
    <tasks>
      - Task 1: Data Layer &amp; Logic (AC: 1)
        - Implement `PlannerRepository` to fetch 7-day forecast from Open-Meteo.
        - Implement `PlannerLogic` (or `StarRatingService`) to calculate 1-5 rating based on Cloud Cover and Moon Phase.
        - Unit Test: Verify rating logic with various weather/moon combinations.
        - Unit Test: Verify API response parsing.
      - Task 2: UI Implementation (AC: 1)
        - Create `ForecastScreen` (or `PlannerScreen`) in `features/planner`.
        - Implement `ForecastListItem` widget using `GlassPanel`.
        - Integrate `WeatherRepository` (or `PlannerRepository`) provider.
        - Widget Test: Verify list renders 7 items and displays correct data.
    </tasks>
  </story>

  <acceptanceCriteria>
    1. **7-Day Forecast List:**
       - [ ] Displays 7 days starting from "Today".
       - [ ] Each item shows: Date, Weather Icon, Cloud Cover %, Star Rating (1-5).
       - [ ] Star Rating logic considers: Cloud Cover, Moon Phase, and **Light Pollution (Bortle Scale)**.
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-4.md</path>
        <title>Epic 4 Technical Specification</title>
        <section>Detailed Design</section>
        <snippet>
          Defines `DailyForecast` model, `PlannerRepository` responsibility, and Star Rating logic.
          API: `GET /api/weather/forecast?lat=...&amp;long=...&amp;days=7`
        </snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Document</title>
        <section>Implementation Patterns</section>
        <snippet>
          **Result Pattern:** Repositories MUST return `Future&lt;Either&lt;Failure, Type&gt;&gt;`.
          **Glass Pattern:** All container widgets should use the shared `GlassPanel` widget.
        </snippet>
      </doc>
      <doc>
        <path>docs/ui-design-system.md</path>
        <title>UI Design System</title>
        <section>Core Components</section>
        <snippet>
          Use `GlassPanel` for list items to maintain "Deep Cosmos" aesthetic.
        </snippet>
      </doc>
    </docs>
    <code>
      <item>
        <path>lib/features/dashboard/domain/repositories/i_weather_repository.dart</path>
        <kind>interface</kind>
        <symbol>IWeatherRepository</symbol>
        <reason>Existing weather repository interface. `PlannerRepository` should follow similar pattern or extend functionality.</reason>
      </item>
      <item>
        <path>lib/core/widgets/glass_panel.dart</path>
        <kind>widget</kind>
        <symbol>GlassPanel</symbol>
        <reason>Standard container widget for UI consistency.</reason>
      </item>
    </code>
    <dependencies>
      <package>flutter_riverpod</package>
      <package>dio</package>
      <package>fpdart</package>
      <package>sweph</package>
      <package>intl</package>
    </dependencies>
  </artifacts>

  <constraints>
    - **Architecture:** Clean Architecture (Data/Domain/Presentation layers).
    - **State Management:** Riverpod 2.0 (Code Generation).
    - **Error Handling:** Use `fpdart`'s `Either&lt;Failure, T&gt;`.
    - **Offline:** Cache forecast data for 1 hour.
    - **UI:** Must use `GlassPanel` and `FlexColorScheme` theme.
  </constraints>

  <interfaces>
    <interface>
      <name>Open-Meteo Forecast API</name>
      <kind>REST</kind>
      <signature>GET /v1/forecast?hourly=cloudcover,visibility&amp;daily=weathercode,sunrise,sunset&amp;timezone=auto</signature>
      <path>https://open-meteo.com/en/docs</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Use `flutter_test` for unit and widget tests.
      Mock external dependencies (repositories) using `mockito` or manual mocks.
      Test `PlannerLogic` thoroughly for rating calculation edge cases.
    </standards>
    <locations>
      <path>test/features/planner</path>
    </locations>
    <ideas>
      <test AC="1">Verify `PlannerLogic` returns 5 stars for 0% cloud + New Moon.</test>
      <test AC="1">Verify `PlannerLogic` returns 1 star for 100% cloud.</test>
      <test AC="1">Verify `ForecastScreen` renders 7 list items.</test>
      <test AC="1">Verify Date formatting matches locale.</test>
    </ideas>
  </tests>
</story-context>

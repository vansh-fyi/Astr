<story-context id="8-2-darkness-quality-r6-calculation" v="1.0">
  <metadata>
    <epicId>8</epicId>
    <storyId>2</storyId>
    <title>Darkness Quality (r^6 Calculation)</title>
    <status>drafted</status>
    <generatedAt>2025-11-30</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/story-8-2-darkness-quality-r6-calculation.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>Advanced User</asA>
    <iWant>to see a "Darkness" metric based on the r^6 formula</iWant>
    <soThat>I can understand the combined effect of light pollution and moon interference on the night sky quality</soThat>
    <tasks>
      - Task 1: Research & Algorithm Design
      - Task 2: Implementation
      - Task 3: Integration
      - Task 4: UI Display
      - Task 5: Documentation
    </tasks>
  </story>

  <acceptanceCriteria>
    1. r^6 Darkness Calculation: System calculates "Darkness" metric using the r^6 model (derived from David Lorenz's work). Inputs: Light Pollution (MPSAS or Bortle), Moon Phase/Illumination, and potentially Moon Altitude. Output: A metric (e.g., 0-100 or qualitative) representing the effective darkness.
    2. Algorithm Documentation: Formula explicitly documented in `docs/calculations.md`. Code comments include citations (e.g., `djlorenz.github.io`). Explanation of how Moon interference degrades the base Light Pollution score.
    3. Data Integration: Integrates Light Pollution data (from Story 8.0/2.4 architecture). Integrates Moon data (Phase/Altitude from Story 1.2/3.4). Updates dynamically as time/conditions change.
    4. UI Display: Displayed in `AtmosphericsSheet` (alongside Seeing, Cloud Cover). Consistent visual language (Card with value, label, and color coding). Example: "Darkness: 21.5 MPSAS (Excellent)" or similar.
    5. Unit Testing: Verify calculation logic against reference values (if available) or expected behavior (e.g., Full Moon = Low Darkness score). Test edge cases (New Moon, Moon below horizon).
  </acceptanceCriteria>

  <artifacts>
    <docs>
      - path: docs/PRD.md
        title: Product Requirements Document
        section: Functional Requirements
        snippet: FR15.1: Light Pollution Data Sources â€” System supports multiple light pollution data sources with fallback strategy. FR15: System calculates celestial positions and moon interference using accurate ephemeris data.
      - path: docs/epics.md
        title: Epics & Stories
        section: Epic 8: Calculation Accuracy & Math Transparency
        snippet: Story 8.2: Darkness Quality (r^6 Calculation). System calculates r^6 Darkness (web research: likely David Lorenz's website implementation). Formula reverse-engineered from `djlorenz.github.io/astronomy/lp/overlay/dark.html`.
      - path: docs/architecture.md
        title: Architecture Document
        section: Implementation Patterns
        snippet: "Backend Data Services" Pattern (NASA + Vercel + MongoDB). Light pollution data must use pre-computed architecture with offline fallback.
      - path: docs/calculations.md
        title: Calculations Documentation
        section: Atmospheric Seeing
        snippet: (Target for new r^6 documentation)
    </docs>
    <code>
      - path: lib/core/services/seeing_calculator.dart
        kind: service
        symbol: SeeingCalculator
        lines: 27-116
        reason: Reference implementation for pure Dart calculation service. Follow this pattern for `DarknessCalculator`.
      - path: lib/features/dashboard/data/repositories/weather_repository_impl.dart
        kind: repository
        symbol: WeatherRepositoryImpl
        lines: 9-46
        reason: Example of integrating a calculator service into a repository.
      - path: lib/features/dashboard/presentation/widgets/atmospherics_sheet.dart
        kind: widget
        symbol: AtmosphericsSheet
        reason: Target UI widget for displaying the Darkness metric.
    </code>
    <dependencies>
      - ecosystem: flutter
        packages:
          - swisseph: (for Moon position/phase)
          - fpdart: (for Result type)
          - riverpod: (for state management)
    </dependencies>
  </artifacts>

  <constraints>
    - Service Isolation: Keep `DarknessCalculator` as a pure logic class, independent of Flutter/Riverpod.
    - Data Source: Must use existing Light Pollution and Moon data sources; do not introduce new external API calls if possible.
    - Documentation: Mandatory update to `docs/calculations.md` with formula and citations.
  </constraints>

  <interfaces>
    - name: DarknessCalculator
      kind: class interface
      signature: (double, String) calculateDarkness({required double mpsas, required double moonPhase, required double moonAltitude})
      path: lib/core/services/darkness_calculator.dart (proposed)
  </interfaces>

  <tests>
    <standards>Unit tests for calculator logic are mandatory. Widget tests for UI display are required.</standards>
    <locations>test/core/services/</locations>
    <ideas>
      - Test New Moon condition (Darkness should equal base Light Pollution).
      - Test Full Moon condition (Darkness should be significantly degraded).
      - Test Moon below horizon (Darkness should equal base Light Pollution regardless of phase).
    </ideas>
  </tests>
</story-context>

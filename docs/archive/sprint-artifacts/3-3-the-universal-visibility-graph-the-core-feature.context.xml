<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>3</epicId>
    <storyId>3.3</storyId>
    <title>The Universal Visibility Graph (Core Feature)</title>
    <status>drafted</status>
    <generatedAt>2025-11-29</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/3-3-the-universal-visibility-graph-the-core-feature.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>User</asA>
    <iWant>see a graph of the object's altitude vs. the moon's interference</iWant>
    <soThat>I can find the "Prime View" window</soThat>
    <tasks>
- Domain Layer (AC: 4, 5, 6)
  - Define VisibilityGraphData entity (list of time/altitude points, optimal time ranges)
  - Define GraphPoint entity (time, altitude value)
  - Define TimeRange entity (start time, end time)
  - Define IVisibilityService interface

- Data Layer (AC: 4, 5, 6, 9)
  - Implement VisibilityService (calculates visibility curve for an object)
  - Use IAstroEngine.getPosition() to calculate altitude for object at time intervals (every 15 minutes for 12 hours = 48 points)
  - Use IAstroEngine.getPosition() to calculate moon altitude and IAstroEngine.getMoonIllumination() for moon brightness
  - Calculate "Moon Interference" factor: combination of moon altitude and illumination percentage
  - Identify "Prime Window" time ranges: Object altitude > 30° AND Moon interference < threshold (< 30%)
  - Optimize calculations to meet < 200ms performance target (consider using compute for isolate if needed)

- Presentation Layer (AC: 1, 2, 3, 7, 8)
  - Create VisibilityGraphNotifier (Riverpod) to calculate and manage graph data
  - Integrate VisibilityGraphNotifier into ObjectDetailScreen
  - Create VisibilityGraphWidget that wraps the Rive animation
  - Bind calculated data to Rive state machine inputs (objectAltitude, moonInterference, isOptimal, timeScrubber)
  - Replace "Coming Soon" placeholder in ObjectDetailScreen with actual VisibilityGraphWidget

- Rive Asset (AC: 7)
  - Create visibility_graph.riv Rive file with Artboard: VisibilityGraph, State Machine: GraphLogic
  - Inputs: objectAltitude (Number 0-100), moonInterference (Number 0-100), timeScrubber (Number 0-100), isOptimal (Boolean)
  - Design: Deep Cosmos background, Neon Cyan object line (#00E5FF), White moon gradient
  - Add to assets/rive/visibility_graph.riv
  - Update pubspec.yaml to include Rive asset

- Testing
  - Unit Test: VisibilityService.calculateVisibility() returns correct number of points (48 for 12h at 15min intervals)
  - Unit Test: VisibilityService correctly identifies Prime Window when object > 30° and moon low
  - Unit Test: VisibilityService handles edge cases (object never rises, object circumpolar)
  - Unit Test: Moon interference calculation combines altitude and illumination correctly
  - Widget Test: VisibilityGraphWidget displays without error when given valid data
  - Integration Test: Full flow from ObjectDetailScreen → VisibilityService → Rive rendering
  - Performance Test: Graph calculation completes in < 200ms
    </tasks>
  </story>

  <acceptanceCriteria>
1. Graph Display: Graph is embedded in the Object Detail Page (Story 3.2) below the basic data section.
2. X-Axis (Time): Shows time from Now to +12 hours with clear labels (e.g., "6 PM", "9 PM", "12 AM").
3. Y-Axis (Altitude): Shows altitude from 0° (horizon) to 90° (zenith).
4. Object Altitude Curve: Line graph showing the object's altitude over the 12-hour period. Color: Neon Cyan (#00E5FF).
5. Moon Interference Overlay: Gradient or secondary curve showing moon's brightness/altitude. Color: White (#FFFFFF) with variable opacity based on moon phase and altitude.
6. Prime Window Highlighting: Time ranges where Object Altitude > 30° AND Moon Interference is low are visually highlighted (e.g., green glow or highlighted region).
7. Rive Integration: The graph is implemented using Rive animation with state machine inputs: objectAltitude (Number, 0-100), moonInterference (Number, 0-100), timeScrubber (Number, 0-100), isOptimal (Boolean).
8. Interactive Scrubber: User can drag a time scrubber to see altitude values at different times (optional for MVP, but Rive should support it).
9. Performance: Graph calculation and rendering must complete in < 200ms for 12 hours of data.
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/architecture.md</path>
        <title>System Architecture - Astr</title>
        <section>The "Rive" Pattern (Interactive Visuals)</section>
        <snippet>Complex visualizations (Graphs, Star Maps) must use Rive. Performance (60fps), small file size, and state-machine interactivity. Design in Rive Editor, export .riv file, bind data to State Machine Inputs.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>System Architecture - Astr</title>
        <section>The "Result" Pattern (No Crashes)</section>
        <snippet>Repositories MUST return Future&lt;Either&lt;Failure, Type&gt;&gt;. Forces the UI to handle the "Left" (Error) case. Prevents silent crashes.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>System Architecture - Astr</title>
        <section>The "Glass" Pattern (UI)</section>
        <snippet>All container widgets should use the shared GlassPanel widget for consistent "Deep Cosmos" aesthetic and performance.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-3.md</path>
        <title>Epic Technical Specification: Celestial Catalog & Visibility Graph</title>
        <section>Services and Modules</section>
        <snippet>VisibilityService: Calculates the visibility curve for a specific object and location over a time range. Inputs: CelestialObject, GeoLocation, DateTime. Outputs: VisibilityGraphData (Points). MoonInterferenceLogic: Calculates the "Moon Wash" factor based on Moon Phase and Altitude.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-3.md</path>
        <title>Epic Technical Specification: Celestial Catalog & Visibility Graph</title>
        <section>Data Models and Contracts</section>
        <snippet>VisibilityGraphData contains objectCurve, moonCurve, optimalWindows. GraphPoint has time and value (altitude in degrees or interference percentage). IVisibilityService interface defines calculateVisibility method.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-3.md</path>
        <title>Epic Technical Specification: Celestial Catalog & Visibility Graph</title>
        <section>Non-Functional Requirements - Performance</section>
        <snippet>Graph Calculation: Generating 12 hours of data points (approx 48 points) must take &lt; 200ms on mid-range devices. Animation: The Visibility Graph must render at 60fps.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/3-2-object-detail-page-shell.md</path>
        <title>Story 3.2: Object Detail Page Shell</title>
        <section>Learnings</section>
        <snippet>Placeholder Pattern: Story 3.2 has a "Visibility Graph - Coming Soon" section at object_detail_screen.dart:230-282. Replace this with the actual graph widget.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>lib/features/astronomy/domain/repositories/i_astro_engine.dart</path>
        <kind>interface</kind>
        <symbol>IAstroEngine</symbol>
        <lines>6-22</lines>
        <reason>MUST REUSE for calculating object and moon positions. Critical for graph data calculation. Provides getPosition() and getMoonIllumination() methods.</reason>
      </artifact>
      <artifact>
        <path>lib/features/catalog/domain/repositories/i_catalog_repository.dart</path>
        <kind>interface</kind>
        <symbol>ICatalogRepository</symbol>
        <lines>1-10</lines>
        <reason>Already used in Story 3.2 for fetching CelestialObject. Context for the object being graphed.</reason>
      </artifact>
      <artifact>
        <path>lib/features/catalog/domain/entities/celestial_object.dart</path>
        <kind>entity</kind>
        <symbol>CelestialObject</symbol>
        <lines>4-30</lines>
        <reason>Input entity for VisibilityService. Contains id, name, type, ephemerisId needed for astro calculations.</reason>
      </artifact>
      <artifact>
        <path>lib/core/widgets/astr_rive_animation.dart</path>
        <kind>widget</kind>
        <symbol>AstrRiveAnimation</symbol>
        <lines>9-41</lines>
        <reason>MUST USE for wrapping Rive animations. Provides testMode to prevent FFI crashes in tests. Pattern for loading visibility_graph.riv.</reason>
      </artifact>
      <artifact>
        <path>lib/core/widgets/glass_panel.dart</path>
        <kind>widget</kind>
        <symbol>GlassPanel</symbol>
        <lines>1-50</lines>
        <reason>Use for wrapping the graph widget to maintain visual consistency with "Deep Cosmos" theme.</reason>
      </artifact>
      <artifact>
        <path>lib/features/catalog/presentation/screens/object_detail_screen.dart</path>
        <kind>screen</kind>
        <symbol>ObjectDetailScreen</symbol>
        <lines>230-282</lines>
        <reason>Integration point - replace _buildGraphPlaceholder() with actual VisibilityGraphWidget. Line 63 is where graph should be inserted.</reason>
      </artifact>
      <artifact>
        <path>lib/features/dashboard/presentation/widgets/bortle_bar.dart</path>
        <kind>widget</kind>
        <symbol>BortleBar</symbol>
        <lines>19-50</lines>
        <reason>Reference example of Rive Pattern implementation. Shows how to bind data to State Machine Inputs (_onRiveInit, _updateRiveState pattern).</reason>
      </artifact>
    </code>
    <dependencies>
      <flutter>
        <package name="flutter_riverpod" version="2.6.1">State management for VisibilityGraphNotifier</package>
        <package name="rive" version="0.13.20">Core animation engine for graph visualization</package>
        <package name="fpdart" version="1.1.0">Either&lt;Failure, T&gt; result type for service methods</package>
        <package name="sweph" version="3.2.1+2.10.3">Astronomy calculations via IAstroEngine</package>
        <package name="go_router" version="16.2.4">Navigation (already integrated in Story 3.2)</package>
      </flutter>
      <dev>
        <package name="mockito" version="5.4.6">Mocking for unit tests</package>
        <package name="build_runner" version="2.4.15">Code generation for mocks</package>
        <package name="flutter_test">Widget and unit testing framework</package>
      </dev>
    </dependencies>
  </artifacts>

  <constraints>
- MUST use Either&lt;Failure, T&gt; return type for all service methods (VisibilityService.calculateVisibility)
- MUST use Rive for graph visualization - custom painting is NOT allowed per architecture
- MUST achieve &lt;200ms performance for 12 hours of calculations (48 data points at 15-minute intervals)
- MUST work 100% offline - no network calls allowed
- MUST reuse IAstroEngine from Story 1.2 - do NOT create new astronomy calculation logic
- MUST integrate into ObjectDetailScreen from Story 3.2 - replace placeholder at line 230-282
- MUST follow Rive Pattern from architecture.md: Design → Export .riv → Bind data to State Machine Inputs
- MUST use AstrRiveAnimation.asset() wrapper (not raw RiveAnimation) to support testing
- MUST use GlassPanel for consistent visual styling
- MUST create new domain service interface IVisibilityService (not part of IAstroEngine)
- Moon interference calculation: interference = moonAltitude > 0 ? (moonAltitude * illumination / 100) : 0
- Prime Window logic: objectAltitude > 30 AND interference &lt; 30
- Time range: Now to Now + 12 hours
- Interval: 15 minutes (configurable, increase to 30 min if performance issues)
- If performance &lt;200ms not met with main thread, use compute() to run in isolate
- Rive asset MUST be added to assets/rive/visibility_graph.riv and registered in pubspec.yaml
  </constraints>

  <interfaces>
    <interface>
      <name>IAstroEngine.getPosition</name>
      <kind>Method</kind>
      <signature>Future&lt;Either&lt;Failure, CelestialPosition&gt;&gt; getPosition({required CelestialBody body, required DateTime time, required double latitude, required double longitude})</signature>
      <path>lib/features/astronomy/domain/repositories/i_astro_engine.dart:11-16</path>
    </interface>
    <interface>
      <name>IAstroEngine.getMoonIllumination</name>
      <kind>Method</kind>
      <signature>Future&lt;Either&lt;Failure, double&gt;&gt; getMoonIllumination({required DateTime time})</signature>
      <path>lib/features/astronomy/domain/repositories/i_astro_engine.dart:18-21</path>
    </interface>
    <interface>
      <name>IVisibilityService.calculateVisibility (TO BE CREATED)</name>
      <kind>Service Interface Method</kind>
      <signature>Future&lt;Either&lt;Failure, VisibilityGraphData&gt;&gt; calculateVisibility({required CelestialObject object, required GeoLocation location, required DateTime date})</signature>
      <path>lib/features/catalog/domain/services/i_visibility_service.dart (NEW FILE)</path>
    </interface>
    <interface>
      <name>AstrRiveAnimation.asset</name>
      <kind>Widget Constructor</kind>
      <signature>AstrRiveAnimation.asset(String asset, {Key? key, String? artboard, BoxFit? fit, void Function(Artboard)? onInit})</signature>
      <path>lib/core/widgets/astr_rive_animation.dart:15-21</path>
    </interface>
    <interface>
      <name>Rive State Machine Inputs (TO BE CREATED IN RIVE)</name>
      <kind>Rive State Machine</kind>
      <signature>
        Artboard: "VisibilityGraph"
        State Machine: "GraphLogic"
        Inputs:
          - objectAltitude: SMINumber (0-100) - Normalized altitude of object
          - moonInterference: SMINumber (0-100) - Moon wash intensity
          - timeScrubber: SMINumber (0-100) - Time scrubber position (optional for MVP)
          - isOptimal: SMIBool - True when in Prime Window
      </signature>
      <path>assets/rive/visibility_graph.riv (NEW ASSET)</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
Flutter testing framework with mockito for mocking dependencies. Use @GenerateMocks annotation to generate mocks. MUST use provideDummy for Either&lt;Failure, T&gt; types in setUpAll(). Unit tests verify service logic and calculations. Widget tests verify UI rendering. Integration tests verify end-to-end flows. Performance tests verify &lt;200ms requirement. Set AstrRiveAnimation.testMode = true in widget test setUp() to prevent Rive FFI crashes.
    </standards>
    <locations>
test/features/catalog/domain/services/ - Unit tests for VisibilityService
test/features/catalog/presentation/providers/ - Unit tests for VisibilityGraphNotifier
test/features/catalog/presentation/widgets/ - Widget tests for VisibilityGraphWidget
test/features/catalog/presentation/screens/ - Integration tests for ObjectDetailScreen with graph
    </locations>
    <ideas>
- AC #1: Widget test - Verify VisibilityGraphWidget is rendered in ObjectDetailScreen below data section
- AC #2: Widget test - Verify X-axis labels display time range (Now to +12h) with formatted labels
- AC #3: Widget test - Verify Y-axis range covers 0° to 90°
- AC #4: Unit test - Verify object altitude curve data uses Neon Cyan color (#00E5FF) in Rive inputs
- AC #5: Unit test - Verify moon interference overlay data calculated with correct opacity based on phase
- AC #6: Unit test - Verify Prime Window highlighting when objectAltitude > 30 AND interference &lt; 30
- AC #7: Widget test - Verify Rive State Machine receives correct inputs (objectAltitude, moonInterference, isOptimal)
- AC #8: Widget test - Verify time scrubber input binding (if implemented)
- AC #9: Performance test - Verify calculateVisibility() completes in &lt; 200ms for 48 data points
- Unit test - Verify VisibilityService returns 48 points for 12h at 15-min intervals
- Unit test - Verify moon interference calculation: moonAlt * illumination / 100
- Unit test - Verify edge case: object never rises (all altitudes &lt; 0)
- Unit test - Verify edge case: circumpolar object (all altitudes > 0)
- Unit test - Verify IAstroEngine.getPosition called correctly for each time interval
- Unit test - Verify IAstroEngine.getMoonIllumination called for moon data
- Integration test - Full flow: ObjectDetailScreen → VisibilityGraphNotifier → VisibilityService → Rive rendering
- Widget test - Verify AstrRiveAnimation wrapper used (not raw RiveAnimation)
- Widget test - Verify graph displays without error when given valid VisibilityGraphData
    </ideas>
  </tests>
</story-context>

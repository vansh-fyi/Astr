<story_context story_id="9-3-forecast-data-wiring">
    <story_definition>
        <title>Forecast Data Wiring</title>
        <user_story>As a User, I want the 7-Day Forecast to show real weather and moon phases, so that I can trust the "Excellent/Good/Poor" ratings.</user_story>
        <acceptance_criteria>
            <criterion id="1">
                <description>Connect `ForecastScreen` to `WeatherRepository` to fetch 7-day forecast from Open-Meteo API.</description>
                <verification_steps>
                    <step>Verify `WeatherRepository` fetches 7 days of daily data.</step>
                    <step>Verify `ForecastScreen` receives this data.</step>
                </verification_steps>
            </criterion>
            <criterion id="2">
                <description>Calculate Moon Phase for each of the next 7 days using the `AstronomyEngine`.</description>
                <verification_steps>
                    <step>Verify `AstronomyEngine` is called for each forecast date.</step>
                    <step>Verify moon phase is correctly calculated.</step>
                </verification_steps>
            </criterion>
            <criterion id="3">
                <description>Apply the "Good/Bad" logic (from Story 2.2) to each day's data to generate a Star Rating (1-5).</description>
                <verification_steps>
                    <step>Verify star rating logic considers cloud cover, moon phase, and seeing.</step>
                    <step>Verify rating is between 1 and 5.</step>
                </verification_steps>
            </criterion>
            <criterion id="4">
                <description>Populate the `ForecastScreen` list with real data (Date, Weather Icon, Star Rating).</description>
                <verification_steps>
                    <step>Verify list items show correct date and icon.</step>
                    <step>Verify segmented bar reflects the star rating.</step>
                </verification_steps>
            </criterion>
        </acceptance_criteria>
    </story_definition>

    <technical_context>
        <architecture_alignment>
            <component>WeatherRepository</component>
            <description>Responsible for fetching weather data from Open-Meteo.</description>
            <pattern>Repository Pattern</pattern>
        </architecture_alignment>
        <architecture_alignment>
            <component>AstronomyService</component>
            <description>Responsible for calculating moon phases.</description>
            <pattern>Service Pattern</pattern>
        </architecture_alignment>
        <architecture_alignment>
            <component>ForecastScreen</component>
            <description>UI for displaying the 7-day forecast.</description>
            <pattern>Presentation Layer (Riverpod)</pattern>
        </architecture_alignment>
        <existing_code_references>
            <reference path="lib/features/dashboard/domain/repositories/i_weather_repository.dart">Interface for weather repository.</reference>
            <reference path="lib/features/dashboard/data/repositories/weather_repository_impl.dart">Implementation of weather repository.</reference>
            <reference path="lib/features/astronomy/domain/services/astronomy_service.dart">Service for astronomical calculations.</reference>
            <reference path="lib/features/planner/presentation/pages/forecast_screen.dart">UI for the forecast screen.</reference>
        </existing_code_references>
    </technical_context>

    <implementation_guide>
        <step>Update `IWeatherRepository` and `WeatherRepositoryImpl` to include a method for fetching 7-day forecast (e.g., `getDailyForecast`).</step>
        <step>Update `OpenMeteoWeatherService` (if needed) to fetch daily parameters (weathercode, cloudcover_mean, etc.).</step>
        <step>Add a method to `AstronomyService` to calculate moon phase for a given date (if not already present or easily derivable).</step>
        <step>Create `ForecastLogic` or similar to encapsulate the star rating calculation (reusing logic from Story 2.2 if possible).</step>
        <step>Create `ForecastNotifier` (Riverpod) to coordinate fetching weather and moon data, and calculating ratings.</step>
        <step>Update `ForecastScreen` to watch `ForecastNotifier` and render the list using `DailyForecast` entities.</step>
    </implementation_guide>
</story_context>

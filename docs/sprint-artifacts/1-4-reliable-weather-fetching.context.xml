<?xml version="1.0" encoding="UTF-8"?>
<story_context>
    <metadata>
        <story_id>1.4</story_id>
        <story_key>1-4-reliable-weather-fetching</story_key>
        <generated_date>2025-12-03</generated_date>
        <status>ready-for-dev</status>
    </metadata>

    <story_definition>
        <user_story>
            As a Stargazer,
            I want to see accurate weather data (cloud cover, seeing) for my location,
            so that I can plan my observation sessions and know if conditions are suitable.
        </user_story>
        <acceptance_criteria>
            <criterion id="1">Weather API Integration: Successfully fetch weather data from Open-Meteo API for a given location.</criterion>
            <criterion id="2">Data Parsing: Parse JSON response to extract cloud cover (%), seeing (if available, or derived), and temperature.</criterion>
            <criterion id="3">Error Handling: Handle network errors, timeouts, and invalid API responses gracefully using `Result&lt;T&gt;`.</criterion>
            <criterion id="4">Data Model: Map API response to a domain `Weather` entity.</criterion>
            <criterion id="5">Performance: Weather fetch completes in &lt; 2s under normal network conditions.</criterion>
        </acceptance_criteria>
    </story_definition>

    <artifacts>
        <documentation>
            <doc path="docs/sprint-artifacts/tech-spec-epic-1.md" description="Detailed Design &amp; NFRs (Weather Service)"/>
            <doc path="docs/architecture.md" description="Project Structure &amp; Error Handling Patterns"/>
        </documentation>
        <code_references>
            <ref path="lib/core/engine/models/result.dart" description="Result&lt;T&gt; pattern for error handling"/>
            <ref path="lib/core/engine/models/location.dart" description="Location model for API requests"/>
            <ref path="pubspec.yaml" description="Dependencies (http)"/>
        </code_references>
        <dependencies>
            <dep name="http" version="^1.6.0" status="present"/>
        </dependencies>
    </artifacts>

    <constraints>
        <constraint type="architectural">Must use Result&lt;T&gt; for all service methods (no unchecked exceptions).</constraint>
        <constraint type="architectural">Follow Repository pattern: Service -> Data Source -> API.</constraint>
        <constraint type="performance">API fetch must timeout after 2 seconds.</constraint>
        <constraint type="data">Open-Meteo API: https://api.open-meteo.com/v1/forecast</constraint>
    </constraints>

    <interfaces>
        <interface name="IWeatherService">
            <method>Future&lt;Result&lt;Weather&gt;&gt; getWeather(Location location)</method>
        </interface>
        <interface name="IWeatherDataSource">
            <method>Future&lt;Weather?&gt; getWeather(Location location)</method>
        </interface>
    </interfaces>

    <testing_strategy>
        <unit_tests>
            <test>Mock DataSource success -> Verify Service returns Result.success with Weather data</test>
            <test>Mock DataSource failure/null -> Verify Service returns Result.failure</test>
            <test>Mock API JSON parsing -> Verify correct mapping to Weather model</test>
        </unit_tests>
        <integration_tests>
            <test>Real API call (if permissible) or robust mock -> Verify network handling and timeout</test>
        </integration_tests>
        <manual_verification>
            <step>Trigger weather fetch -> Verify data appears (or error handled if offline)</step>
        </manual_verification>
    </testing_strategy>
</story_context>

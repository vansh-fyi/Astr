<story-context id="1-1-dart-native-engine-implementation-context" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>1.1</storyId>
    <title>Dart Native Engine Implementation</title>
    <status>drafted</status>
    <generatedAt>2025-12-03</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/1-1-dart-native-engine-implementation.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>Stargazer</asA>
    <iWant>the app to calculate celestial positions locally on my device</iWant>
    <soThat>I can use the app without an internet connection</soThat>
    <tasks>
- [ ] Setup Engine Structure (AC: #4)
  - [ ] Create `lib/core/engine/models` (CelestialObject, Coordinates, RiseSetTimes)
  - [ ] Define `IAstroEngine` interface in `lib/core/engine/interfaces`
  - [ ] Implement `Result&lt;T&gt;` pattern for error handling
- [ ] Implement Core Algorithms (AC: #1, #2)
  - [ ] Implement Julian Date conversion
  - [ ] Implement Local Sidereal Time calculation
  - [ ] Implement Equatorial to Horizontal coordinate conversion
  - [ ] Implement Rise/Set time calculation logic
- [ ] Implement Isolate Manager (AC: #3)
  - [ ] Create `IsolateManager` to handle background thread spawning
  - [ ] Implement message passing for calculation requests/results
  - [ ] Ensure error propagation from Isolate to Main thread
- [ ] Testing &amp; Verification
  - [ ] Write unit tests for `AstroEngine` against "Gold Standard" data (AC: #1, #2)
  - [ ] Profile Isolate performance to ensure main thread remains unblocked (AC: #3)
    </tasks>
  </story>

  <acceptanceCriteria>
1. **Engine Accuracy**: `calculatePosition()` returns Alt/Az within 1 degree of Stellarium/verified sources.
2. **Rise/Set Accuracy**: Rise/Set times are within 2 minutes of verified sources.
3. **Performance**: UI does not freeze during heavy calculation operations (must use Isolates).
4. **Code Structure**: `IAstroEngine` interface and `AstroEngine` implementation created in `lib/core/engine`.
  </acceptanceCriteria>

  <artifacts>
    <docs>
      - path: docs/sprint-artifacts/tech-spec-epic-1.md
        title: Epic 1 Tech Spec
        section: Detailed Design
        snippet: Implementation of IAstroEngine using Dart Native algorithms (Meeus).
      - path: docs/architecture.md
        title: Architecture Decision Document
        section: 2. Architectural Decisions
        snippet: Concurrency: Dart Isolates. Heavy Meeus algorithms must run off the main thread.
    </docs>
    <code>
      <!-- No existing engine code in lib/core/engine -->
    </code>
    <dependencies>
      - flutter_isolate: (Missing in pubspec.yaml, required for AC #3)
      - sweph: (Legacy, to be replaced)
    </dependencies>
  </artifacts>

  <constraints>
    - Any calculation >16ms must be offloaded to Isolate.
    - Use Result&lt;T&gt; pattern for error handling.
    - Do not throw unchecked exceptions.
    - Follow naming conventions: IAstroEngine (interface), AstroEngine (impl).
  </constraints>

  <interfaces>
    - name: IAstroEngine
      kind: interface
      signature: Future&lt;Result&lt;EquatorialCoordinates&gt;&gt; calculatePosition(CelestialObject obj, Location loc, DateTime time);
      path: lib/core/engine/interfaces/i_astro_engine.dart (Proposed)
    - name: IAstroEngine
      kind: interface
      signature: Future&lt;Result&lt;RiseSetTimes&gt;&gt; calculateRiseSet(CelestialObject obj, Location loc, DateTime date);
      path: lib/core/engine/interfaces/i_astro_engine.dart (Proposed)
  </interfaces>

  <tests>
    <standards>Unit tests against Gold Standard data (Stellarium/sweph).</standards>
    <locations>test/core/engine/</locations>
    <ideas>
      - Test Julian Date conversion against known values.
      - Test Coordinate conversion against Stellarium data.
      - Verify Isolate communication does not block main thread.
    </ideas>
  </tests>
</story-context>

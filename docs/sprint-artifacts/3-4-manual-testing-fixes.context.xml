<story_context id="3-4-manual-testing-fixes">
  <story_meta>
    <epic_id>3</epic_id>
    <story_id>4</story_id>
    <title>Manual Testing Fixes</title>
    <status>drafted</status>
    <story_key>3-4-manual-testing-fixes</story_key>
  </story_meta>

  <user_story>
    <as_a>developer</as_a>
    <i_want>to address specific issues found during manual testing (math accuracy, UI glitches, UX flows)</i_want>
    <so_that>the app provides accurate data and a smooth user experience for the production release</so_that>
  </user_story>

  <acceptance_criteria>
    <criterion id="1">
      <text>Light Pollution &amp; Visibility Math: Investigate and calibrate Bortle/Visibility logic. Ensure dark sky locations reflect lower zones. Ensure "Excellent" condition is achievable.</text>
    </criterion>
    <criterion id="2">
      <text>Moon Icon Size: Increase display size of moon phase icon on Home Screen to compensate for padding.</text>
    </criterion>
    <criterion id="3">
      <text>Cloud Cover Date Limits: Restrict cloud cover data to +/- 10 days. Show UI message if out of range.</text>
    </criterion>
    <criterion id="4">
      <text>Location Selection UX: Auto-select newly added locations.</text>
    </criterion>
    <criterion id="5">
      <text>Reload Behavior: Persist selected Location and Date across app restarts/reloads.</text>
    </criterion>
    <criterion id="6">
      <text>Rise/Set Times Missing: Ensure Rise, Set, and Transit times are calculated and displayed for ALL celestial object types (Stars, DSOs).</text>
    </criterion>
    <criterion id="7">
      <text>Ko-fi Rebranding: Replace "Buy me a coffee" with Ko-fi link (https://ko-fi.com/vanshgrover) and custom text.</text>
    </criterion>
    <criterion id="8">
      <text>App Icon: Configure launcher icon using assets/img/logo.png with Blue-800 background.</text>
    </criterion>
    <criterion id="9">
      <text>Splash Screen Animation: Loop Lottie logo exactly 3 times before transitioning.</text>
    </criterion>
    <criterion id="10">
      <text>Custom Loading Indicator: Replace spinner with assets/lottie/loader.json and cycling "Cosmic" text.</text>
    </criterion>
    <criterion id="11">
      <text>SQM Data on Graph: Implement real SQM calculation or remove placeholder.</text>
    </criterion>
  </acceptance_criteria>

  <tasks>
    <task>Math &amp; Logic Fixes (AC #1, #3, #11)</task>
    <task>UX &amp; State Management (AC #4, #5)</task>
    <task>UI &amp; Assets (AC #2, #7, #8, #9, #10)</task>
    <task>Data Display (AC #6)</task>
  </tasks>

  <artifacts>
    <docs>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-3.md</path>
        <title>Epic 3 Tech Spec</title>
        <section>Detailed Design</section>
        <snippet>QualitativeConditionService analyzes environmental factors to determine observing quality. ConditionQuality enum defines excellent, good, fair, poor.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Decision Document</title>
        <section>Architectural Decisions</section>
        <snippet>State Mgmt: Riverpod. Persistence: get_storage/shared_preferences. LP Map Format: WebP.</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epics and Stories</title>
        <section>Story 3.4</section>
        <snippet>Scope: Includes UI glitches, edge case crashes, and minor usability tweaks found during the QA phase.</snippet>
      </doc>
    </docs>

    <code>
      <item>
        <path>lib/core/services/light_pollution/light_pollution_service.dart</path>
        <kind>service</kind>
        <symbol>LightPollutionService</symbol>
        <reason>Logic for Bortle/SQM calculation (AC #1, #11)</reason>
      </item>
      <item>
        <path>lib/core/services/qualitative/qualitative_condition_service.dart</path>
        <kind>service</kind>
        <symbol>QualitativeConditionService</symbol>
        <reason>Logic for "Excellent" condition thresholds (AC #1)</reason>
      </item>
      <item>
        <path>lib/features/splash/presentation/splash_screen.dart</path>
        <kind>widget</kind>
        <symbol>SplashScreen</symbol>
        <reason>Splash animation loop logic (AC #9)</reason>
      </item>
      <item>
        <path>lib/features/splash/presentation/providers/initialization_provider.dart</path>
        <kind>provider</kind>
        <symbol>InitializationProvider</symbol>
        <reason>Hook for restoring persisted state (AC #5)</reason>
      </item>
      <item>
        <path>lib/features/profile/presentation/providers/saved_locations_provider.dart</path>
        <kind>provider</kind>
        <symbol>SavedLocationsProvider</symbol>
        <reason>Logic for adding and selecting locations (AC #4)</reason>
      </item>
      <item>
        <path>lib/features/catalog/presentation/screens/object_detail_screen.dart</path>
        <kind>widget</kind>
        <symbol>ObjectDetailScreen</symbol>
        <reason>Display of Rise/Set times for DSOs (AC #6)</reason>
      </item>
    </code>

    <dependencies>
      <dep key="flutter_launcher_icons">dev_dependency (AC #8)</dep>
      <dep key="get_storage">dependency (AC #5)</dep>
      <dep key="lottie">dependency (AC #9, #10)</dep>
    </dependencies>
  </artifacts>

  <tests>
    <standards>
      Use `flutter test` for unit logic (Math, Services). Use `integration_test` for critical flows if needed. Manual verification required for UI/Animation changes.
    </standards>
    <locations>
      <loc>test/</loc>
      <loc>integration_test/</loc>
    </locations>
    <ideas>
      <idea ac_id="1">Unit test `Bortle` calculation with known dark sky coordinates.</idea>
      <idea ac_id="3">Unit test `CloudCoverService` with dates > 10 days out.</idea>
      <idea ac_id="5">Manual test: Change location, restart app, verify location persists.</idea>
      <idea ac_id="9">Visual test: Verify Splash loops exactly 3 times.</idea>
    </ideas>
  </tests>
</story_context>

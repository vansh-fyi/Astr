<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>2.1</storyId>
    <title>Standardize Graph Timeframes</title>
    <status>drafted</status>
    <generatedAt>2025-12-03</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/2-1-standardize-graph-timeframes.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>Stargazer</asA>
    <iWant>all graphs (Atmospherics, Visibility) to display the relevant observing night (Sunset to Sunrise)</iWant>
    <soThat>I can see the data in the context of my actual observing session</soThat>
    <tasks>
      - Implement GraphTimeframeProvider (AC: #1, #2)
      - Update Atmospherics Graph (AC: #1, #3)
      - Update Visibility Graph (AC: #1, #3)
      - Testing &amp; Verification (AC: #1, #2, #3)
    </tasks>
  </story>

  <acceptanceCriteria>
    1. Timeframe Logic: All graphs (Atmospherics, Visibility) display an X-axis spanning from Sunset of the selected date to Sunrise of the following day.
    2. Context Continuity: If the current time is outside this window (e.g., noon), the graph still shows the upcoming/previous night context relevant to the user's selection.
    3. Consistency: Logic is applied consistently across both Atmospherics and Visibility graphs.
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-2.md</path>
        <title>Epic 2 Technical Specification</title>
        <section>Detailed Design</section>
        <snippet>GraphTimeframeProvider: Calculates the start (Sunset) and end (Sunrise) timestamps for the graph X-axis. Inputs: Selected Date, Location. Outputs: DateTimeRange.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Decision Document</title>
        <section>4. Implementation Patterns</section>
        <snippet>Naming Conventions: Classes: PascalCase, Variables/Functions: camelCase. Error Handling: Result Pattern. Performance: Isolate Boundary >16ms.</snippet>
      </doc>
    </docs>
    <code>
      <item>
        <path>lib/features/dashboard/presentation/widgets/cloud_cover_graph_painter.dart</path>
        <kind>component</kind>
        <symbol>CloudCoverGraphPainter</symbol>
        <lines>5-164</lines>
        <reason>Existing painter for Atmospherics graph. Needs to receive updated startTime/endTime from provider.</reason>
      </item>
      <item>
        <path>lib/features/catalog/presentation/widgets/visibility_graph_painter.dart</path>
        <kind>component</kind>
        <symbol>VisibilityGraphPainter</symbol>
        <lines>9-540</lines>
        <reason>Existing painter for Visibility graph. Needs to receive updated startTime/endTime from provider.</reason>
      </item>
      <item>
        <path>lib/features/catalog/domain/entities/visibility_graph_data.dart</path>
        <kind>model</kind>
        <symbol>VisibilityGraphData</symbol>
        <lines>5-41</lines>
        <reason>Data model for visibility graph. May need adjustment if timeframe logic affects data structure (unlikely, but good context).</reason>
      </item>
    </code>
    <dependencies>
      <dep>flutter</dep>
      <dep>flutter_riverpod</dep>
      <dep>intl</dep>
    </dependencies>
  </artifacts>

  <constraints>
    - Do NOT redesign the graphs. Only update the data range logic.
    - Use Riverpod for state management (GraphTimeframeProvider).
    - Ensure timeframe calculation is fast (synchronous if possible).
    - Maintain 60fps performance for graph rendering.
  </constraints>

  <interfaces>
    <interface>
      <name>GraphTimeframeProvider</name>
      <kind>Riverpod Provider</kind>
      <signature>Provider&lt;DateTimeRange&gt;((ref) => ...)</signature>
      <path>lib/core/providers/graph_timeframe_provider.dart</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Unit tests for logic (timeframe calculation). Widget tests for painters to verify X-axis range and rendering.
    </standards>
    <locations>
      test/core/providers/
      test/features/dashboard/presentation/widgets/
      test/features/catalog/presentation/widgets/
    </locations>
    <ideas>
      - Verify Sunset/Sunrise calculation for various dates and locations.
      - Verify behavior when current time is noon (should show tonight's graph).
      - Verify graph painters respect the provided startTime and endTime.
    </ideas>
  </tests>
</story-context>
